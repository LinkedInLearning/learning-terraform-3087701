name: "Infracost analysis"

on:
  # trigger only when PR is raised because infracost needs to compare two branches to get cost difference
  pull_request:
    branches: [ main ]
    paths: 'terraform/**'

permissions:  # added using https://github.com/step-security/secure-workflows
  contents: read

jobs:
  infracost:
    permissions:
      contents: write
      pull-requests: write
    uses: wenqiglantz/reusable-workflows-modules/.github/workflows/terraform-infracost-pr.yml@latest
    with:
      terraform-var-file: ./.env/dev/terraform.tfvars 
      usage-file: ./.env/dev/infracost-usage.yml 
    secrets: inherit

  send-email:
    needs: infracost
    uses: wenqiglantz/reusable-workflows-modules/.github/workflows/send-email.yml@latest
    with:
      to: your-email@your-domain.com
      subject: ${{ github.repository }} Cloud Cost Report
      body: Attached please find the cloud cost report generated by Infracost from worflow ${{ github.workflow }} of ${{ github.repository }}.
      attachment-flag: true
      attachments: report.html
    secrets: inherit
    